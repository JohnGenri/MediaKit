#!/bin/bash
# Exit immediately if any command fails
set -e

# --- HARDCODED PARAMETERS (do not change) ---
PROXY_STRING="YOUR_PROXY_HERE"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
COOKIE_FILE="$SCRIPT_DIR/important/www.instagram.com_cookies.txt"

# --- DYNAMIC PARAMETERS (passed from Python) ---
VIDEO_URL="$1"
FINAL_OUTPUT_FILE="$2"

# --- Check if Python passed all data ---
if [ -z "$VIDEO_URL" ] || [ -z "$FINAL_OUTPUT_FILE" ]; then
  echo "Critical error: Python script did not pass URL or filename." >&2
  exit 1
fi

# --- Temporary files for video and audio ---
VIDEO_PART="temp_video_$(uuidgen).mp4"
AUDIO_PART="temp_audio_$(uuidgen).m4a"


# --- STAGE 1: Get links via proxy ---
echo "Stage 1: Getting links via proxy..."
URLS=$(yt-dlp \
  --get-url \
  --proxy "$PROXY_STRING" \
  --cookies "$COOKIE_FILE" \
  "$VIDEO_URL")

VIDEO_DL_URL=$(echo "$URLS" | head -n 1)
AUDIO_DL_URL=$(echo "$URLS" | tail -n 1)


# --- STAGE 2: Download parts directly (no proxy) ---
echo "Stage 2: Downloading parts directly..."
/usr/bin/aria2c --no-conf -x1 --http-proxy='' --https-proxy='' -o "$VIDEO_PART" "$VIDEO_DL_URL"
/usr/bin/aria2c --no-conf -x1 --http-proxy='' --https-proxy='' -o "$AUDIO_PART" "$AUDIO_DL_URL"


# --- STAGE 3: Merge video and audio ---
echo "Stage 3: Assembling final file..."
ffmpeg -y -v quiet -i "$VIDEO_PART" -i "$AUDIO_PART" -c copy "$FINAL_OUTPUT_FILE"


# --- STAGE 4: Cleanup ---
rm "$VIDEO_PART" "$AUDIO_PART"

echo "Done! File saved as $FINAL_OUTPUT_FILE"
